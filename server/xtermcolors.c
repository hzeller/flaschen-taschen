/* This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation version 2.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://gnu.org/licenses/gpl-2.0.txt>
 *
 * This file is taken from pixelterm by jaseg <pixelterm@jaseg.net>,
 * the most recent version may be found at https://github.com/jaseg/pixelterm
 */

/* generated from xtermcolors.py */

#include <math.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>
#include <sys/types.h>

#include "xtermcolors.h"

void rgb_to_yuv(uint32_t rgba_in, struct yuv_color *out) {
    union rgba_color c = {.i = rgba_in};
    float r = ((float)c.c.r)/256.0F,
          g = ((float)c.c.g)/256.0F,
          b = ((float)c.c.b)/256.0F;
	out->y =  0.29900F*r + 0.58700F*g + 0.11400F+b;
	out->u = -0.14713F*r - 0.28886F*g + 0.43600F*b;
	out->v =  0.61500F*r - 0.51499F*g - 0.10001F*b;
}

float yuv_dist(struct yuv_color *c1yuv, struct yuv_color *c2yuv) {
    float y, u, v;
    y = fabsf(c1yuv->y - c2yuv->y);
    u = fabsf(c1yuv->u - c2yuv->u);
    v = fabsf(c1yuv->v - c2yuv->v);
//    printf("      yuv1 %f,%f,%f yuv1 %f,%f,%f dyuv %f,%f,%f", c1yuv->y, c1yuv->u, c1yuv->v, c2yuv->y, c2yuv->u, c2yuv->v, y, u, v);
    return y*y + u*u + v*v;
}

int xterm_closest_color(uint32_t rgba_col) {
//    printf("Finding closest color for %x\n", rgba_col);
    float dmin = 12;
    int   imin = -1;
    struct yuv_color colyuv;
    rgb_to_yuv(rgba_col, &colyuv);
    for (size_t i=0; i<240; i++) {
        float dist = yuv_dist(&colyuv, xtermcolors_yuv+i);
        if (rgba_col != 0)
//            printf("dist-%zd: %f\n", colyuv.y, colyuv.u, colyuv.v, i, dist);
        if (dist < dmin) {
            dmin = dist;
            imin = i;
        }
    }
//    printf("    Found: %d\n", imin);
    return imin+16; /* ansi standard colors are left out here due to poor portability */
}

struct yuv_color xtermcolors_yuv[240] = {
    {0.1140000000, 0.0000000000, 0.0000000000},
    {0.4850937500, 0.1617968750, -0.0371130859},
    {0.6413437500, 0.2299218750, -0.0527396484},
    {0.7975937500, 0.2980468750, -0.0683662109},
    {0.9538437500, 0.3661718750, -0.0839927734},
    {1.1100937500, 0.4342968750, -0.0996193359},
    {0.3318320312, -0.1071941406, -0.1911095703},
    {0.7029257813, 0.0546027344, -0.2282226562},
    {0.8591757813, 0.1227277344, -0.2438492187},
    {1.0154257813, 0.1908527344, -0.2594757812},
    {1.1716757813, 0.2589777344, -0.2751023437},
    {1.3279257813, 0.3271027344, -0.2907289062},
    {0.4235507812, -0.1523285156, -0.2715767578},
    {0.7946445312, 0.0094683594, -0.3086898437},
    {0.9508945312, 0.0775933594, -0.3243164062},
    {1.1071445312, 0.1457183594, -0.3399429687},
    {1.2633945312, 0.2138433594, -0.3555695312},
    {1.4196445312, 0.2819683594, -0.3711960937},
    {0.5152695312, -0.1974628906, -0.3520439453},
    {0.8863632812, -0.0356660156, -0.3891570312},
    {1.0426132812, 0.0324589844, -0.4047835937},
    {1.1988632812, 0.1005839844, -0.4204101562},
    {1.3551132812, 0.1687089844, -0.4360367187},
    {1.5113632812, 0.2368339844, -0.4516632812},
    {0.6069882813, -0.2425972656, -0.4325111328},
    {0.9780820313, -0.0808003906, -0.4696242187},
    {1.1343320313, -0.0126753906, -0.4852507812},
    {1.2905820313, 0.0554496094, -0.5008773438},
    {1.4468320313, 0.1235746094, -0.5165039062},
    {1.6030820313, 0.1916996094, -0.5321304687},
    {0.6987070312, -0.2877316406, -0.5129783203},
    {1.0698007813, -0.1259347656, -0.5500914062},
    {1.2260507813, -0.0578097656, -0.5657179687},
    {1.3823007813, 0.0103152344, -0.5813445312},
    {1.5385507813, 0.0784402344, -0.5969710937},
    {1.6948007813, 0.1465652344, -0.6125976562},
    {0.2249570312, -0.0545990234, 0.2282226562},
    {0.5960507812, 0.1071978516, 0.1911095703},
    {0.7523007812, 0.1753228516, 0.1754830078},
    {0.9085507812, 0.2434478516, 0.1598564453},
    {1.0648007812, 0.3115728516, 0.1442298828},
    {1.2210507812, 0.3796978516, 0.1286033203},
    {0.4427890625, -0.1617931641, 0.0371130859},
    {0.8138828125, 0.0000037109, 0.0000000000},
    {0.9701328125, 0.0681287109, -0.0156265625},
    {1.1263828125, 0.1362537109, -0.0312531250},
    {1.2826328125, 0.2043787109, -0.0468796875},
    {1.4388828125, 0.2725037109, -0.0625062500},
    {0.5345078125, -0.2069275391, -0.0433541016},
    {0.9056015625, -0.0451306641, -0.0804671875},
    {1.0618515625, 0.0229943359, -0.0960937500},
    {1.2181015625, 0.0911193359, -0.1117203125},
    {1.3743515625, 0.1592443359, -0.1273468750},
    {1.5306015625, 0.2273693359, -0.1429734375},
    {0.6262265625, -0.2520619141, -0.1238212891},
    {0.9973203125, -0.0902650391, -0.1609343750},
    {1.1535703125, -0.0221400391, -0.1765609375},
    {1.3098203125, 0.0459849609, -0.1921875000},
    {1.4660703125, 0.1141099609, -0.2078140625},
    {1.6223203125, 0.1822349609, -0.2234406250},
    {0.7179453125, -0.2971962891, -0.2042884766},
    {1.0890390625, -0.1353994141, -0.2414015625},
    {1.2452890625, -0.0672744141, -0.2570281250},
    {1.4015390625, 0.0008505859, -0.2726546875},
    {1.5577890625, 0.0689755859, -0.2882812500},
    {1.7140390625, 0.1371005859, -0.3039078125},
    {0.8096640625, -0.3423306641, -0.2847556641},
    {1.1807578125, -0.1805337891, -0.3218687500},
    {1.3370078125, -0.1124087891, -0.3374953125},
    {1.4932578125, -0.0442837891, -0.3531218750},
    {1.6495078125, 0.0238412109, -0.3687484375},
    {1.8057578125, 0.0919662109, -0.3843750000},
    {0.2716757812, -0.0775880859, 0.3243164063},
    {0.6427695312, 0.0842087891, 0.2872033203},
    {0.7990195312, 0.1523337891, 0.2715767578},
    {0.9552695312, 0.2204587891, 0.2559501953},
    {1.1115195312, 0.2885837891, 0.2403236328},
    {1.2677695312, 0.3567087891, 0.2246970703},
    {0.4895078125, -0.1847822266, 0.1332068359},
    {0.8606015625, -0.0229853516, 0.0960937500},
    {1.0168515625, 0.0451396484, 0.0804671875},
    {1.1731015625, 0.1132646484, 0.0648406250},
    {1.3293515625, 0.1813896484, 0.0492140625},
    {1.4856015625, 0.2495146484, 0.0335875000},
    {0.5812265625, -0.2299166016, 0.0527396484},
    {0.9523203125, -0.0681197266, 0.0156265625},
    {1.1085703125, 0.0000052734, 0.0000000000},
    {1.2648203125, 0.0681302734, -0.0156265625},
    {1.4210703125, 0.1362552734, -0.0312531250},
    {1.5773203125, 0.2043802734, -0.0468796875},
    {0.6729453125, -0.2750509766, -0.0277275391},
    {1.0440390625, -0.1132541016, -0.0648406250},
    {1.2002890625, -0.0451291016, -0.0804671875},
    {1.3565390625, 0.0229958984, -0.0960937500},
    {1.5127890625, 0.0911208984, -0.1117203125},
    {1.6690390625, 0.1592458984, -0.1273468750},
    {0.7646640625, -0.3201853516, -0.1081947266},
    {1.1357578125, -0.1583884766, -0.1453078125},
    {1.2920078125, -0.0902634766, -0.1609343750},
    {1.4482578125, -0.0221384766, -0.1765609375},
    {1.6045078125, 0.0459865234, -0.1921875000},
    {1.7607578125, 0.1141115234, -0.2078140625},
    {0.8563828125, -0.3653197266, -0.1886619141},
    {1.2274765625, -0.2035228516, -0.2257750000},
    {1.3837265625, -0.1353978516, -0.2414015625},
    {1.5399765625, -0.0672728516, -0.2570281250},
    {1.6962265625, 0.0008521484, -0.2726546875},
    {1.8524765625, 0.0689771484, -0.2882812500},
    {0.3183945313, -0.1005771484, 0.4204101562},
    {0.6894882813, 0.0612197266, 0.3832970703},
    {0.8457382813, 0.1293447266, 0.3676705078},
    {1.0019882813, 0.1974697266, 0.3520439453},
    {1.1582382813, 0.2655947266, 0.3364173828},
    {1.3144882813, 0.3337197266, 0.3207908203},
    {0.5362265625, -0.2077712891, 0.2293005859},
    {0.9073203125, -0.0459744141, 0.1921875000},
    {1.0635703125, 0.0221505859, 0.1765609375},
    {1.2198203125, 0.0902755859, 0.1609343750},
    {1.3760703125, 0.1584005859, 0.1453078125},
    {1.5323203125, 0.2265255859, 0.1296812500},
    {0.6279453125, -0.2529056641, 0.1488333984},
    {0.9990390625, -0.0911087891, 0.1117203125},
    {1.1552890625, -0.0229837891, 0.0960937500},
    {1.3115390625, 0.0451412109, 0.0804671875},
    {1.4677890625, 0.1132662109, 0.0648406250},
    {1.6240390625, 0.1813912109, 0.0492140625},
    {0.7196640625, -0.2980400391, 0.0683662109},
    {1.0907578125, -0.1362431641, 0.0312531250},
    {1.2470078125, -0.0681181641, 0.0156265625},
    {1.4032578125, 0.0000068359, 0.0000000000},
    {1.5595078125, 0.0681318359, -0.0156265625},
    {1.7157578125, 0.1362568359, -0.0312531250},
    {0.8113828125, -0.3431744141, -0.0121009766},
    {1.1824765625, -0.1813775391, -0.0492140625},
    {1.3387265625, -0.1132525391, -0.0648406250},
    {1.4949765625, -0.0451275391, -0.0804671875},
    {1.6512265625, 0.0229974609, -0.0960937500},
    {1.8074765625, 0.0911224609, -0.1117203125},
    {0.9031015625, -0.3883087891, -0.0925681641},
    {1.2741953125, -0.2265119141, -0.1296812500},
    {1.4304453125, -0.1583869141, -0.1453078125},
    {1.5866953125, -0.0902619141, -0.1609343750},
    {1.7429453125, -0.0221369141, -0.1765609375},
    {1.8991953125, 0.0459880859, -0.1921875000},
    {0.3651132812, -0.1235662109, 0.5165039062},
    {0.7362070312, 0.0382306641, 0.4793908203},
    {0.8924570312, 0.1063556641, 0.4637642578},
    {1.0487070312, 0.1744806641, 0.4481376953},
    {1.2049570312, 0.2426056641, 0.4325111328},
    {1.3612070312, 0.3107306641, 0.4168845703},
    {0.5829453125, -0.2307603516, 0.3253943359},
    {0.9540390625, -0.0689634766, 0.2882812500},
    {1.1102890625, -0.0008384766, 0.2726546875},
    {1.2665390625, 0.0672865234, 0.2570281250},
    {1.4227890625, 0.1354115234, 0.2414015625},
    {1.5790390625, 0.2035365234, 0.2257750000},
    {0.6746640625, -0.2758947266, 0.2449271484},
    {1.0457578125, -0.1140978516, 0.2078140625},
    {1.2020078125, -0.0459728516, 0.1921875000},
    {1.3582578125, 0.0221521484, 0.1765609375},
    {1.5145078125, 0.0902771484, 0.1609343750},
    {1.6707578125, 0.1584021484, 0.1453078125},
    {0.7663828125, -0.3210291016, 0.1644599609},
    {1.1374765625, -0.1592322266, 0.1273468750},
    {1.2937265625, -0.0911072266, 0.1117203125},
    {1.4499765625, -0.0229822266, 0.0960937500},
    {1.6062265625, 0.0451427734, 0.0804671875},
    {1.7624765625, 0.1132677734, 0.0648406250},
    {0.8581015625, -0.3661634766, 0.0839927734},
    {1.2291953125, -0.2043666016, 0.0468796875},
    {1.3854453125, -0.1362416016, 0.0312531250},
    {1.5416953125, -0.0681166016, 0.0156265625},
    {1.6979453125, 0.0000083984, 0.0000000000},
    {1.8541953125, 0.0681333984, -0.0156265625},
    {0.9498203125, -0.4112978516, 0.0035255859},
    {1.3209140625, -0.2495009766, -0.0335875000},
    {1.4771640625, -0.1813759766, -0.0492140625},
    {1.6334140625, -0.1132509766, -0.0648406250},
    {1.7896640625, -0.0451259766, -0.0804671875},
    {1.9459140625, 0.0229990234, -0.0960937500},
    {0.4118320312, -0.1465552734, 0.6125976562},
    {0.7829257812, 0.0152416016, 0.5754845703},
    {0.9391757812, 0.0833666016, 0.5598580078},
    {1.0954257812, 0.1514916016, 0.5442314453},
    {1.2516757812, 0.2196166016, 0.5286048828},
    {1.4079257812, 0.2877416016, 0.5129783203},
    {0.6296640625, -0.2537494141, 0.4214880859},
    {1.0007578125, -0.0919525391, 0.3843750000},
    {1.1570078125, -0.0238275391, 0.3687484375},
    {1.3132578125, 0.0442974609, 0.3531218750},
    {1.4695078125, 0.1124224609, 0.3374953125},
    {1.6257578125, 0.1805474609, 0.3218687500},
    {0.7213828125, -0.2988837891, 0.3410208984},
    {1.0924765625, -0.1370869141, 0.3039078125},
    {1.2487265625, -0.0689619141, 0.2882812500},
    {1.4049765625, -0.0008369141, 0.2726546875},
    {1.5612265625, 0.0672880859, 0.2570281250},
    {1.7174765625, 0.1354130859, 0.2414015625},
    {0.8131015625, -0.3440181641, 0.2605537109},
    {1.1841953125, -0.1822212891, 0.2234406250},
    {1.3404453125, -0.1140962891, 0.2078140625},
    {1.4966953125, -0.0459712891, 0.1921875000},
    {1.6529453125, 0.0221537109, 0.1765609375},
    {1.8091953125, 0.0902787109, 0.1609343750},
    {0.9048203125, -0.3891525391, 0.1800865234},
    {1.2759140625, -0.2273556641, 0.1429734375},
    {1.4321640625, -0.1592306641, 0.1273468750},
    {1.5884140625, -0.0911056641, 0.1117203125},
    {1.7446640625, -0.0229806641, 0.0960937500},
    {1.9009140625, 0.0451443359, 0.0804671875},
    {0.9965390625, -0.4342869141, 0.0996193359},
    {1.3676328125, -0.2724900391, 0.0625062500},
    {1.5238828125, -0.2043650391, 0.0468796875},
    {1.6801328125, -0.1362400391, 0.0312531250},
    {1.8363828125, -0.0681150391, 0.0156265625},
    {1.9926328125, 0.0000099609, 0.0000000000},
    {0.1140000000, 0.0000000000, 0.0000000000},
    {0.2466093750, 0.0000007031, 0.0000000000},
    {0.3202812500, 0.0000010938, 0.0000000000},
    {0.3939531250, 0.0000014844, 0.0000000000},
    {0.4676250000, 0.0000018750, 0.0000000000},
    {0.5412968750, 0.0000022656, 0.0000000000},
    {0.6149687500, 0.0000026562, 0.0000000000},
    {0.6886406250, 0.0000030469, 0.0000000000},
    {0.7623125000, 0.0000034375, 0.0000000000},
    {0.8359843750, 0.0000038281, 0.0000000000},
    {0.9096562500, 0.0000042188, 0.0000000000},
    {0.9833281250, 0.0000046094, 0.0000000000},
    {1.0570000000, 0.0000050000, 0.0000000000},
    {1.1306718750, 0.0000053906, 0.0000000000},
    {1.2043437500, 0.0000057813, -0.0000000000},
    {1.2780156250, 0.0000061719, 0.0000000000},
    {1.3516875000, 0.0000065625, 0.0000000000},
    {1.4253593750, 0.0000069531, 0.0000000000},
    {1.4990312500, 0.0000073437, 0.0000000000},
    {1.5727031250, 0.0000077344, 0.0000000000},
    {1.6463750000, 0.0000081250, 0.0000000000},
    {1.7200468750, 0.0000085156, 0.0000000000},
    {1.7937187500, 0.0000089062, 0.0000000000},
    {1.8673906250, 0.0000092969, 0.0000000000}
};
